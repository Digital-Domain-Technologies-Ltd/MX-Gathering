name: Pull Request Checks

on:
  pull_request:
    branches: [main, staging, dev]
    paths:
      - 'web/**'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-html:
    name: Validate HTML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install html-validate
        run: npm install -g html-validate

      - name: Validate HTML files
        run: html-validate "web/**/*.html"

  check-links:
    name: Check Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check links
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress --accept 200,429 'web/**/*.html'
          fail: true

  accessibility:
    name: Accessibility Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install -g http-server pa11y-ci

      - name: Start server
        run: |
          cd web
          http-server -p 8080 &
          sleep 3

      - name: Run Pa11y
        run: pa11y-ci http://localhost:8080/index.html

  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install -g http-server @lhci/cli

      - name: Start server
        run: |
          cd web
          http-server -p 8080 &
          sleep 3

      - name: Run Lighthouse CI
        run: lhci autorun
        env:
          LHCI_BUILD_CONTEXT__CURRENT_BRANCH: ${{ github.head_ref }}

  summary:
    name: Checks Summary
    runs-on: ubuntu-latest
    needs: [validate-html, check-links, accessibility, lighthouse]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.validate-html.result }}" != "success" ] || \
             [ "${{ needs.check-links.result }}" != "success" ] || \
             [ "${{ needs.accessibility.result }}" != "success" ] || \
             [ "${{ needs.lighthouse.result }}" != "success" ]; then
            echo "Some checks failed. Please review the results above."
            exit 1
          fi
          echo "All checks passed! âœ…"
